<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:svg="clr-namespace:Avalonia.Svg.Skia;assembly=Avalonia.Svg.Skia"
             xmlns:cv="using:HyPrism.UI.Converters"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="300"
             x:Class="HyPrism.UI.Components.Inputs.SelectionInput.SelectionInput"
             x:Name="Root"
             ClipToBounds="False">
             <!-- ZIndex handled in code-behind to avoid StaticResource resolution issues -->

    <UserControl.Resources>
        <cv:StringEqualityConverter x:Key="StringEqualityConverter"/>
    </UserControl.Resources>
    
    <!-- Outer container: Needs explicit height to not be expanded by canvas if we used one -->
    <!-- But here we use a simple grid flow. The dropdown is floating. -->
    
    <Grid RowDefinitions="Auto, Auto" ClipToBounds="False">
        
        <!-- ROW 0: Label + Toggle -->
        <StackPanel Grid.Row="0" Spacing="8">
             <!-- Label -->
            <TextBlock Text="{Binding ElementName=Root, Path=Label}" 
                       FontSize="15" 
                       FontWeight="SemiBold" 
                       Foreground="White"
                       IsVisible="{Binding ElementName=Root, Path=Label, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
            
            <!-- Input Container -->
            <!-- ToggleButton IS the container now -->
            <ToggleButton Name="DropdownToggle" 
                          Classes="InputToggle"
                          Height="44"
                          IsChecked="{Binding ElementName=Root, Path=IsExpanded, Mode=TwoWay}">
                <Grid ColumnDefinitions="*, Auto">
                    <!-- Text / Content -->
                    <ContentControl Grid.Column="0"
                                   Content="{Binding ElementName=Root, Path=SelectedItem}"
                                   ContentTemplate="{Binding ElementName=Root, Path=ItemTemplate}"
                                   VerticalAlignment="Center"
                                   HorizontalAlignment="Left">
                         <ContentControl.DataTemplates>
                             <!-- Simple string fallback if no template -->
                             <DataTemplate DataType="x:String">
                                 <TextBlock Text="{Binding}" FontSize="14" Foreground="White" />
                             </DataTemplate>
                             <!-- Fallback for objects if template is missing uses ToString -->
                             <DataTemplate DataType="x:Object">
                                 <TextBlock Text="{Binding}" FontSize="14" Foreground="White"/>
                             </DataTemplate>
                         </ContentControl.DataTemplates>
                    </ContentControl>
                    
                    <!-- Placeholder if null -->
                    <TextBlock Grid.Column="0" 
                               Text="{Binding ElementName=Root, Path=Placeholder}"
                               IsVisible="{Binding ElementName=Root, Path=SelectedItem, Converter={x:Static ObjectConverters.IsNull}}"
                               Foreground="Gray"
                               FontSize="14"
                               VerticalAlignment="Center"/>
                    
                    <!-- Icon -->
                    <svg:Svg Grid.Column="1" 
                             Classes="Chevron"
                             Path="/Assets/Icons/chevron-up.svg" 
                             Width="16" Height="16"
                             Margin="10,0,0,0">
                         <svg:Svg.Transitions>
                             <Transitions>
                                 <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut"/>
                             </Transitions>
                         </svg:Svg.Transitions>
                    </svg:Svg>
                </Grid>
            </ToggleButton>
        </StackPanel>
        
        <!-- ROW 1: The Overlay Dropdown -->
        <!-- We use a Canvas to break out of flow layout but stay in visual tree -->
        <Canvas Name="DropdownPlaceholder"
            Classes.down="{Binding ElementName=Root, Path=Direction, Converter={StaticResource StringEqualityConverter}, ConverterParameter=Down}"
            Classes.up="{Binding ElementName=Root, Path=Direction, Converter={StaticResource StringEqualityConverter}, ConverterParameter=Up}"
            Height="0"
            HorizontalAlignment="Stretch"
            ClipToBounds="False">
             <Grid Name="DropdownContainer"
                 Classes.expanded="{Binding ElementName=Root, Path=IsExpanded}"
               Classes.down="{Binding ElementName=Root, Path=Direction, Converter={StaticResource StringEqualityConverter}, ConverterParameter=Down}"
               Classes.up="{Binding ElementName=Root, Path=Direction, Converter={StaticResource StringEqualityConverter}, ConverterParameter=Up}"
                 ClipToBounds="False">
                   
                    <Border Background="#F2111111"
                        BorderBrush="#1AFFFFFF"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="6"
                        MinWidth="{Binding $parent[UserControl].Bounds.Width}"
                        MaxHeight="300"
                        BoxShadow="0 8 32 0 #66000000">
                    <ScrollViewer VerticalScrollBarVisibility="Hidden">
                        <ListBox Classes="SelectionList"
                                 ItemsSource="{Binding ElementName=Root, Path=ItemsSource}"
                                 SelectedItem="{Binding ElementName=Root, Path=SelectedItem}"
                                 ItemTemplate="{Binding ElementName=Root, Path=ItemTemplate}"
                                 Background="Transparent"
                                 SelectionChanged="OnListBoxSelectionChanged"/>
                    </ScrollViewer>
                </Border>
             </Grid>
        </Canvas>
    </Grid>

</UserControl>
