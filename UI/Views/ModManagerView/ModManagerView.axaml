<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HyPrism.UI.Views.ModManagerView"
             xmlns:closeButton="using:HyPrism.UI.Components.Buttons.CloseButton"
             xmlns:svg="clr-namespace:Avalonia.Svg.Skia;assembly=Avalonia.Svg.Skia"
             xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
             x:Class="HyPrism.UI.Views.ModManagerView.ModManagerView"
             x:DataType="vm:ModManagerViewModel"
             x:CompileBindings="True">

    <Border Background="#F2111111" CornerRadius="16" BorderBrush="#1AFFFFFF" BorderThickness="1" ClipToBounds="True" BoxShadow="0 10 30 5 #000000">
        <Grid RowDefinitions="60, *">
            
            <!-- Header -->
            <Grid Grid.Row="0" Background="#CC0D0D0D" ColumnDefinitions="Auto, *, Auto">
                <StackPanel Orientation="Horizontal" Spacing="15" Margin="20,0">
                    <TextBlock Text="Mod Manager" VerticalAlignment="Center" FontSize="18" FontWeight="Bold" Foreground="White" FontFamily="{StaticResource Poppins}"/>
                    <Rectangle Width="1" Height="20" Fill="#333" VerticalAlignment="Center"/>
                    
                    <!-- Tabs -->
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <Button Classes="NavButton" Command="{Binding SwitchTabCommand}" CommandParameter="installed">
                            <Panel>
                                <TextBlock Text="Installed" IsVisible="{Binding IsBrowseTab}"/>
                                <TextBlock Text="Installed" IsVisible="{Binding IsInstalledTab}" Foreground="White" FontWeight="Bold"/>
                            </Panel>
                        </Button>
                        <Button Classes="NavButton" Command="{Binding SwitchTabCommand}" CommandParameter="browse">
                            <Panel>
                                <TextBlock Text="Browse" IsVisible="{Binding IsInstalledTab}"/>
                                <TextBlock Text="Browse" IsVisible="{Binding IsBrowseTab}" Foreground="White" FontWeight="Bold"/>
                            </Panel>
                        </Button>
                    </StackPanel>
                </StackPanel>
                
                <closeButton:CloseButton Grid.Column="2" 
                                     Command="{Binding CloseCommand}" 
                                     Margin="0,0,20,0"/>
            </Grid>

            <!-- Content -->
            <Grid Grid.Row="1" Background="#CC0D0D0D">
                
                <!-- Loading Overlay -->
                <Grid Panel.ZIndex="100" Background="#80000000" IsVisible="{Binding IsLoading}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="10">
                        <ProgressBar IsIndeterminate="True" Width="100"/>
                        <TextBlock Text="{Binding LoadingText}" HorizontalAlignment="Center" Foreground="White" FontSize="16"/>
                    </StackPanel>
                </Grid>
                
                <!-- Installed Tab -->
                <Grid IsVisible="{Binding IsInstalledTab}" Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <Grid Grid.Row="0" Margin="0,0,0,15" ColumnDefinitions="*, Auto">
                        <TextBox Grid.Column="0" Watermark="Search installed mods..." Margin="0,0,10,0" Background="#0DFFFFFF" Foreground="White" BorderBrush="#0DFFFFFF" BorderThickness="1" Padding="12,12,12,12" CornerRadius="10">
                            <TextBox.InnerLeftContent>
                                <svg:Svg Path="/Assets/Icons/search.svg" Width="16" Height="16" Margin="10,0,5,0"/>
                            </TextBox.InnerLeftContent>
                        </TextBox>
                        <Button Grid.Column="1" Command="{Binding RefreshInstalledCommand}" Background="#1AFFFFFF" CornerRadius="10" Padding="10" BorderBrush="#0DFFFFFF" BorderThickness="1">
                            <svg:Svg Path="/Assets/Icons/refresh-cw.svg" Width="18" Height="18"/>
                        </Button>
                    </Grid>
                    
                    <ListBox Grid.Row="1" ItemsSource="{Binding InstalledMods}" Background="Transparent">
                        <ListBox.Styles>
                           <Style Selector="ListBoxItem">
                               <Setter Property="Padding" Value="0"/>
                               <Setter Property="Margin" Value="0,0,0,8"/>
                               <Setter Property="Background" Value="Transparent"/>
                           </Style>
                           <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                               <Setter Property="Background" Value="Transparent"/>
                           </Style>
                        </ListBox.Styles>
                        <ListBox.ItemTemplate>
                            <DataTemplate x:CompileBindings="False">
                                <Border Background="#1AFFFFFF" CornerRadius="10" Padding="12" BorderThickness="1" BorderBrush="#0DFFFFFF">
                                    <Grid ColumnDefinitions="50, *, Auto">
                                         <!-- Icon -->
                                         <Border Grid.Column="0" Width="42" Height="42" Background="#1AFFFFFF" CornerRadius="8" Margin="0,0,15,0" ClipToBounds="True">
                                            <Image asyncImageLoader:ImageLoader.Source="{Binding IconUrl}" Stretch="UniformToFill"/>
                                         </Border>
                                         
                                         <!-- Info -->
                                         <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                             <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="White" FontSize="15"/>
                                             <TextBlock Text="{Binding Description}" FontSize="13" Foreground="#999" TextTrimming="CharacterEllipsis"/>
                                         </StackPanel>
                                         
                                         <!-- Actions -->
                                         <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                                             <ToggleSwitch IsChecked="{Binding Enabled}" 
                                                           Command="{Binding $parent[UserControl].DataContext.ToggleModCommand}"
                                                           CommandParameter="{Binding}"
                                                           OnContent="" OffContent="" Margin="0,0,10,0"/>

                                             <TextBlock Text="{Binding Version}" VerticalAlignment="Center" Foreground="#666" Margin="0,0,10,0"/>
                                             
                                             <Button Background="Transparent" 
                                                     Command="{Binding $parent[UserControl].DataContext.UninstallModCommand}"
                                                     CommandParameter="{Binding}"
                                                     Foreground="#FF6B6B" Padding="8" BorderThickness="0" CornerRadius="6">
                                                <svg:Svg Path="/Assets/Icons/trash-2.svg" Width="16" Height="16"/>
                                             </Button>
                                         </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
                
                <!-- Browse Tab -->
                <Grid IsVisible="{Binding IsBrowseTab}" ColumnDefinitions="200, *" Margin="20">
                    
                    <!-- Sidebar: Categories -->
                    <Border Grid.Column="0" Background="#0DFFFFFF" CornerRadius="10" Margin="0,0,15,0" Padding="10" BorderThickness="1" BorderBrush="#0DFFFFFF">
                        <Grid RowDefinitions="Auto, *">
                            <TextBlock Grid.Row="0" Text="Categories" FontWeight="Bold" Foreground="White" Margin="5,0,0,10"/>
                            <ListBox Grid.Row="1" ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}" Background="Transparent">
                                <ListBox.Styles>
                                    <Style Selector="ListBoxItem">
                                        <Setter Property="Padding" Value="10,8"/>
                                        <Setter Property="CornerRadius" Value="6"/>
                                    </Style>
                                </ListBox.Styles>
                                <ListBox.ItemTemplate>
                                    <DataTemplate x:CompileBindings="False">
                                        <TextBlock Text="{Binding Name}" Foreground="#CCC"/>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>
                    
                    <!-- Main Area -->
                    <Grid Grid.Column="1" RowDefinitions="Auto, *">
                        <!-- Search Bar -->
                        <Grid Grid.Row="0" Margin="0,0,0,15" ColumnDefinitions="*, Auto">
                             <TextBox Grid.Column="0" Text="{Binding SearchQuery}" Watermark="Search CurseForge..." Background="#0DFFFFFF" Foreground="White" BorderBrush="#0DFFFFFF" BorderThickness="1" Padding="12,12,12,12" CornerRadius="10">
                                <TextBox.InnerLeftContent>
                                    <svg:Svg Path="/Assets/Icons/search.svg" Width="16" Height="16" Margin="10,0,5,0"/>
                                </TextBox.InnerLeftContent>
                                <TextBox.KeyBindings>
                                    <KeyBinding Gesture="Enter" Command="{Binding SearchCommand}"/>
                                </TextBox.KeyBindings>
                             </TextBox>
                             <Button Grid.Column="1" Command="{Binding SearchCommand}" Content="Search" Margin="10,0,0,0" Background="#1AFFFFFF" Foreground="White" Padding="20,0" CornerRadius="10" BorderBrush="#0DFFFFFF" BorderThickness="1"/>
                        </Grid>
                        
                        <!-- Results Grid -->
                        <ScrollViewer Grid.Row="1">
                            <StackPanel>
                                <ItemsControl ItemsSource="{Binding SearchResults}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:CompileBindings="False">
                                            <Border Background="#1AFFFFFF" CornerRadius="12" Padding="10" Margin="5" Width="220" Height="290" BorderThickness="1" BorderBrush="#0DFFFFFF">
                                                <Grid RowDefinitions="Auto, *, Auto">
                                                    <!-- Thumbnail -->
                                                    <Border Grid.Row="0" Height="120" Background="#1AFFFFFF" CornerRadius="8" Margin="0,0,0,10" ClipToBounds="True">
                                                         <Image asyncImageLoader:ImageLoader.Source="{Binding ThumbnailUrl}" Stretch="UniformToFill"/>
                                                    </Border>
                                                    
                                                    <StackPanel Grid.Row="1" Spacing="4">
                                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="White" FontSize="14" TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Text="{Binding Summary}" FontSize="12" Foreground="#888" TextWrapping="Wrap" MaxLines="2" Height="34" TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Text="{Binding Author}" FontSize="11" Foreground="#666"/>
                                                    </StackPanel>
                                                    
                                                    <Button Grid.Row="2" 
                                                            Command="{Binding $parent[UserControl].DataContext.OpenDetailsCommand}"
                                                            CommandParameter="{Binding}"
                                                            Margin="0,10,0,0" 
                                                            HorizontalAlignment="Stretch" 
                                                            HorizontalContentAlignment="Center" 
                                                            Background="#1AFFFFFF" 
                                                            Foreground="White" 
                                                            CornerRadius="8">
                                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                                            <svg:Svg Path="/Assets/Icons/download.svg" Width="16" Height="16"/>
                                                            <TextBlock Text="Details" VerticalAlignment="Center"/>
                                                        </StackPanel>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <Button Content="Load More" 
                                        Command="{Binding LoadMoreCommand}" 
                                        IsVisible="{Binding CanLoadMore}"
                                        HorizontalAlignment="Center" 
                                        Margin="0,20"
                                        Background="Transparent"
                                        BorderBrush="#0DFFFFFF"
                                        BorderThickness="1"
                                        Foreground="#AAA"/>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </Grid>
                
                <!-- Details Overlay -->
                 <Grid IsVisible="{Binding IsDetailsOpen}" Background="#CC0D0D0D" Margin="0">
                     <Grid.RowDefinitions>
                         <RowDefinition Height="Auto"/>
                         <RowDefinition Height="*"/>
                     </Grid.RowDefinitions>
                     
                     <!-- Back Header -->
                     <Button Grid.Row="0" Command="{Binding CloseDetailsCommand}" Background="Transparent" Margin="10" HorizontalAlignment="Left" Foreground="White">
                         <StackPanel Orientation="Horizontal" Spacing="5">
                             <svg:Svg Path="/Assets/Icons/arrow-left.svg" Width="16" Height="16"/>
                             <TextBlock Text="Back to Search" VerticalAlignment="Center"/>
                         </StackPanel>
                     </Button>
                     
                     <Grid Grid.Row="1" ColumnDefinitions="300, *" Margin="20">
                         <!-- Left Info -->
                         <StackPanel Grid.Column="0" Spacing="15">
                             <Border Height="200" CornerRadius="12" ClipToBounds="True" Background="#000">
                                 <Image asyncImageLoader:ImageLoader.Source="{Binding SelectedMod.ThumbnailUrl}" Stretch="UniformToFill"/>
                             </Border>
                             
                             <StackPanel>
                                 <TextBlock Text="{Binding SelectedMod.Name}" FontWeight="Bold" FontSize="20" Foreground="White" TextWrapping="Wrap"/>
                                 <TextBlock Text="{Binding SelectedMod.Author}" FontSize="14" Foreground="#AAA"/>
                                 <TextBlock Text="{Binding SelectedMod.DateUpdated, StringFormat='Updated: {0}'}" FontSize="12" Foreground="#666" Margin="0,5,0,0"/>
                             </StackPanel>
                             
                             <TextBlock Text="Description" FontWeight="Bold" Foreground="White" Margin="0,10,0,0"/>
                             <TextBlock Text="{Binding SelectedMod.Summary}" Foreground="#CCC" TextWrapping="Wrap" FontSize="13"/>
                         </StackPanel>
                         
                         <!-- Right Files -->
                         <Grid Grid.Column="1" RowDefinitions="Auto, *" Margin="20,0,0,0">
                             <TextBlock Grid.Row="0" Text="Files" FontWeight="Bold" FontSize="18" Foreground="White" Margin="0,0,0,15"/>
                             
                             <ListBox Grid.Row="1" ItemsSource="{Binding SelectedModFiles}" Background="#0DFFFFFF" CornerRadius="10">
                                 <ListBox.ItemTemplate>
                                     <DataTemplate x:CompileBindings="False">
                                         <Grid ColumnDefinitions="*, 120, Auto" Margin="5">
                                             <StackPanel Grid.Column="0">
                                                 <TextBlock Text="{Binding DisplayName}" Foreground="White" FontWeight="Medium"/>
                                                 <TextBlock Text="{Binding FileName}" Foreground="#666" FontSize="12"/>
                                             </StackPanel>
                                             
                                             <TextBlock Grid.Column="1" Text="{Binding FileDate}" Foreground="#888" VerticalAlignment="Center" FontSize="12"/>
                                             
                                             <Button Grid.Column="2" 
                                                     Command="{Binding $parent[UserControl].DataContext.InstallModCommand}"
                                                     CommandParameter="{Binding}"
                                                     Content="Install" 
                                                     Background="#1AFFFFFF" 
                                                     Foreground="White" 
                                                     CornerRadius="6" 
                                                     FontSize="12"/>
                                         </Grid>
                                     </DataTemplate>
                                 </ListBox.ItemTemplate>
                             </ListBox>
                         </Grid>
                     </Grid>
                 </Grid>

            </Grid>
        </Grid>
    </Border>

</UserControl>
